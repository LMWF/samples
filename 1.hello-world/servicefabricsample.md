# Dapr on Service Fabric Sample
The following is a sample of how to host a Hello World Dapr app on local Windows box Service Fabric cluster, in line with the Dapr local box sample here:
https://github.com/dapr/samples/tree/master/1.hello-world
 
Some Dapr functionality, such as message invocation, will not work without additional changes and is out of scope for this post.
 
## Instructions:
 
This assumes:
- that you've cloned the Dapr samples repo https://github.com/dapr/samples, and checked out the `servicefabricsample` branch which contains the application package used below
- that you're familiar with the scenario outlined in the Dapr Hello World sample: https://github.com/dapr/samples/tree/master/1.hello-world
 
## Part 1 Setup
1. Go through the instructions in the [Prerequisites](https://github.com/dapr/samples/tree/master/1.hello-world#prerequisites) section in the Dapr Hello World sample.
 
2. Create a basic Service Fabric cluster through the SDK as described here: https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started.  Right click "Service Fabric Local Cluster Manager" in the taskbar and select "Start Local Cluster".  A one node cluster will start more quickly.
 
3. Start Redis by running the following, which is the same command run by the Dapr CLI when executing `dapr --init`: 
    
        docker run --restart always -d -p 6379:6379 redis
 

In the Dapr Hello World sample, Redis is used as a state store, which is how it will be also used below.  Note in this sample it won't be hosted by the Service Fabric cluster.  It is just being run by Docker, just like in the Dapr Hello World sample.  You could also use a remote Redis instance hosted in the cloud, or a different state store type such as [Cosmos DB](https://github.com/dapr/docs/blob/master/howto/setup-state-store/setup-azure-cosmosdb.md).
 
 
## Part 2 Create the Service Fabric Application Package
 
This section will create an application package where daprd.exe and the user node.js app will be run as guest executables in two separate code packages under the same Service Fabric service.  They'll always be co-located.
 
1. Follow the instructions here to install Dapr.  This step is only being performed to get daprd.exe, which will be copied into the application package.
https://github.com/dapr/docs/blob/master/getting-started/environment-setup.md#installing-dapr-cli

2. Checkout the `servicefabricsample` branch.

3. Copy daprd.exe from your local Dapr installation, `c:\dapr`, into `[samples repo root]\1.hello-world\daprsfpkg\MyService\CodeDapr\`.  Make sure you copy _daprd.exe_, not dapr.exe.

        copy c:\dapr\daprd.exe [samples repo root]\1.hello-world\daprsfpkg\MyService\CodeDapr\

4. From `[samples repo root]\1.hello-world\daprsfpkg\MyService\CodeUserApp\`, run `npm install` to install the node.js app's dependencies.
 
5. Confirm the application package is well-formed:

        Test-ServiceFabricApplicationPackage [samples repo root]\1.hello-world\daprsfpkg\

Notes:
- the application package includes the Dapr `components` folder, which stores Dapr component configuration, in the Dapr code package.  In Dapr standalone (local) mode, this is generated by the Dapr CLI. It is included it here so daprd.exe can read it when running on a Service Fabric cluster.
 - the service manifest contains a command to invoke daprd.exe with the same args that the Dapr CLI does in the sample.
 
## Part 3 Create the Service Fabric Application
 
Copy the application package to the cluster, register it, then create the application.
 
In powershell:
 
        cd [samples repo root]\1.hello-world

Copy the application package to the cluster:

        Copy-ServiceFabricApplicationPackage daprsfpkg

Register it: 

        Register-ServiceFabricApplicationType daprsfpkg
 
Create the application instance:

        New-ServiceFabricApplication -ApplicationName fabric:/dapr1 -ApplicationTypeName daprsf -ApplicationTypeVersion 1.0
 
 
You'll see daprd.exe and the node.js app come up on the same node.
 

## Part 4 Post Messages to the Service
 
Now make some calls to make sure everything works:
 
Go to `[samples repo root]\1.hello-world`, if you're not already there.
 
Run the curl commands listed here in the following link:
 
https://github.com/dapr/samples/tree/master/1.hello-world#step-4---post-messages-to-your-service
 
You should see the same input and output.

## Part 5 Cleanup

1. Delete the Service Fabric application instance:

        Remove-ServiceFabricApplication -ApplicationName fabric:/dapr1

2. Unregister the Service Fabric application type

        Unregister-ServiceFabricApplicationType daprsf 1.0